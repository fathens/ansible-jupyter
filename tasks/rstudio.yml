- include_vars: rstudio.yml
- include_vars: '{{ item }}'
  with_first_found:
  - files:
    - 'rstudio-{{ ansible_distribution }}-{{ ansible_distribution_release }}.yml'
    - 'rstudio-{{ ansible_distribution }}.yml'
    - 'rstudio-{{ ansible_os_family }}.yml'
    errors: ignore
    paths:
    - '{{ role_path }}/vars'

- name: install packages
  become: yes
  package:
    name: "{{ item }}"
    state: present
  with_items: "{{ packages }}"

- name: download RStudio
  get_url:
    url: "{{ rstudio_server.url }}"
    checksum: "{{ rstudio_server.checksum }}"
    dest: /tmp/rstudio-server.deb
  when: ansible_os_family == 'Debian'

- name: install RStudio
  become: yes
  command: bash -l -c 'yes | gdebi /tmp/rstudio-server.deb'
  when: ansible_os_family == 'Debian'

- name: remove tmp file
  file:
    path: /tmp/rstudio-server.deb
    state: absent
  when: ansible_os_family == 'Debian'

- name: install R libraries
  become: yes
  command: bash -l -c "Rscript -e 'install.packages(\"{{ item }}\")'"
  with_items: "{{ r_libralies }}"

- name: add user for RStudio
  become: yes
  user:
    name: "{{ rstudio_client.username }}"
    password: "{{ rstudio_client.password | password_hash('sha512') }}"

- name: install IRkernel
  become: yes
  command: bash -l -c "Rscript -e 'install.packages(\"IRkernel\")'"

- name: install IR to jupyter
  command: bash -l -c "Rscript -e 'IRkernel::installspec()'"
